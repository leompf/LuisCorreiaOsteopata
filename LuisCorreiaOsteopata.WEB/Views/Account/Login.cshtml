@model LuisCorreiaOsteopata.WEB.Models.LoginViewModel;

@{
    ViewData["Title"] = "Login";
    Layout = "~/Views/Shared/_Layout2.cshtml";
}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

@section MainMenu
{
    <li>
        <a asp-controller="Home" asp-action="Index">Home</a>
    </li>
}

<!--Page Header Start-->
<section class="page-header">
    <div class="page-header__bg" style="background-image: url(assets/images/backgrounds/page-header-bg.jpg);">
    </div>
    <div class="container">
        <div class="page-header__inner">
            <h3>Login</h3>
            <div class="thm-breadcrumb__inner">
                <ul class="thm-breadcrumb list-unstyled">
                    <li><a asp-controller="Home" asp-action="Index">Home</a></li>
                    <li><span class="icon-arrow-left"></span></li>
                    <li>Login</li>
                </ul>
            </div>
        </div>
    </div>
</section>
<!--Page Header End-->
<!--Start Login One-->
<section class="login-one" id="login-section">
    <div class="container">
        <div class="login-one__form">
            <div class="inner-title text-center">
                <h2>Login</h2>
            </div>
            <form method="post">
                <div hidden asp-validation-summary="ModelOnly"></div>
                <div class="row">
                    <div class="col-xl-12">
                        <div class="form-group">
                            <div class="input-box">
                                <span class="span-validation-error" asp-validation-for="Username"></span>
                                <input asp-for="Username" type="email" placeholder="Email..." />
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-12">
                        <div class="form-group">
                            <div class="input-box">
                                <span class="span-validation-error" asp-validation-for="Password"></span>
                                <input asp-for="Password" type="password" placeholder="Password..." />
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-12">
                        <div class="form-group">
                            <button class="thm-btn" type="submit" data-loading-text="Por favor aguarda...">
                                Login
                                <span class="icon-right-arrow"></span>
                            </button>
                        </div>

                        @if (ViewBag.ShowResendConfirmation == true)
                        {
                            <div class="text-center mt-3">
                                <button type="button" id="resendEmailBtn" class="btn btn-warning">
                                    Reenviar Email de Confirmação
                                </button>
                            </div>
                        }
                    </div>
                    <div class="remember-forget">
                        <div class="checked-box1">
                            <input type="checkbox" asp-for="RememberMe" />
                            <label asp-for="RememberMe">
                                <span asp-validation-for="RememberMe"></span>
                                Lembrar-me
                            </label>
                        </div>
                        <div class="forget">
                            <a href="#">Esqueceste-te da password?</a>
                        </div>
                    </div>
                    <div class="google-facebook justify-content-center">
                        <a asp-action="LoginGoogle">
                            <div class="icon">
                                <img src="~/assets/images/icon/icon-google-2.png" alt="Google">
                            </div>
                            Continuar com Google
                        </a>
                    </div>

                    <div class="create-account text-center">
                        <p>Ainda não tens conta? <a asp-action="SignUp">Regista-te</a></p>
                    </div>
                </div>
            </form>
        </div>
    </div>
</section>
<!--End Login One-->
@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script type="text/javascript">
        document.addEventListener("DOMContentLoaded", function ()
        {
            const loginSection = document.getElementById("login-section");
            if (loginSection)
            {
                loginSection.scrollIntoView({ behavior: "smooth" });
            }

            // Toastify CSS class for vertical center
            const style = document.createElement('style');
            style.innerHTML = `
                .toast-center {
                    top: 50% !important;
                    transform: translateY(-50%) !important;
                }
            `;
            document.head.appendChild(style);

            const modelErrors = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                ViewData.ModelState.Values.SelectMany(v => v.Errors).Select(e => e.ErrorMessage)
            ));

            if (modelErrors.length > 0) {
                modelErrors.forEach(errorMsg => {
                    Toastify({
                        text: errorMsg,
                        duration: 2000,
                        gravity: "center",
                        position: "center",
                        backgroundColor: "#FF4B4B",
                        className: "toast-center"
                    }).showToast();
                });
            }

            const resendBtn = document.getElementById("resendEmailBtn");
            if (resendBtn) {
                resendBtn.addEventListener("click", function () {
                    const email = document.querySelector("#Username").value; // login input
                    if (!email) {
                        Toastify({
                            text: "Por favor insira o seu email.",
                            duration: 3000,
                            gravity: "center",
                            position: "center",
                            backgroundColor: "#FF4B4B",
                            className: "toast-center"
                        }).showToast();
                        return;
                    }

                    const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                    fetch('@Url.Action("ResendEmailConfirmation", "Account")', {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded"
                        },
                        body: `email=${encodeURIComponent(email)}&__RequestVerificationToken=${encodeURIComponent(token)}`
                    })
                    .then(res => res.text())
                    .then(msg => {
                        Toastify({
                            text: msg || "Foi enviado um novo email de confirmação.",
                            duration: 4000,
                            gravity: "center",
                            position: "center",
                            backgroundColor: "#4CAF50",
                            className: "toast-center"
                        }).showToast();
                    })
                    .catch(err => {
                        Toastify({
                            text: "Erro ao enviar email.",
                            duration: 4000,
                            gravity: "center",
                            position: "center",
                            backgroundColor: "#FF4B4B",
                            className: "toast-center"
                        }).showToast();
                    });
                });
            }
        });
    </script>
}
