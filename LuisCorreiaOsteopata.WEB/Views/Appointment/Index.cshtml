@model LuisCorreiaOsteopata.WEB.Models.BookAppointmentViewModel

@{
    ViewData["Title"] = "Marcar Consulta";
    Layout = "~/Views/Shared/_Layout2.cshtml";
}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<style>
    .thm-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>

@section MainMenu
{
    <partial name="_Menu"></partial>
}

<section class="page-header">
    <div class="page-header__bg" style="background-image: url(~/assets/images/backgrounds/page-header-bg.jpg);">
    </div>
    <div class="container">
        <div class="page-header__inner">
            <h3>Marcar Consulta</h3>
            <div class="thm-breadcrumb__inner">
                <ul class="thm-breadcrumb list-unstyled">
                    <li><a asp-controller="Account" asp-action="Index">Home</a></li>
                    <li><span class="icon-arrow-left"></span></li>
                    <li>Marcar Consulta</li>
                </ul>
            </div>
        </div>
    </div>
</section>

<section class="appoinment-page" id="appointment-section">
    <div class="container">
        <div class="row">
            <div class="col-xl-8 col-lg-7">
                <div class="appoinment-page__left">
                    <h3 class="appoinment-page__title">Marcar Consulta</h3>
                    <form class="appoinment-page__form" method="post">
                        <div class="row">
                            @if (!Model.HasAvailableCredits && User.IsInRole("Utente") && ViewBag.AppointmentBookingMessageIsShown is not true)
                            {
                                <div class="alert alert-warning">
                                    Não tens consultas disponíveis. Por favor, adquire uma antes de marcar.
                                </div>
                            }
                            <div class="col-xl-auto col-md-6">
                                <div class="appoinment-page__input-box text-center">
                                    <label style="font-size: 1.0rem" class="col-auto col-form-label"><strong>Data da Consulta:</strong></label>
                                    <input asp-for="AppointmentDate" type="date" id="AppointmentDate" placeholder="Selecione uma data..." />
                                    <span style="display: block;" class="text-danger" asp-validation-for="AppointmentDate"></span>
                                </div>
                            </div>
                            <div class="col-xl-auto col-md-6">
                                <div class="appoinment-page__input-box text-center">
                                    <label style="font-size: 1.0rem" class="col-auto col-form-label"><strong>Hora:</strong></label>
                                    <select asp-for="StartTime" asp-items="Model.TimeSlots" id="timeSlots"></select>
                                    <span style="display: block;" class="text-danger" asp-validation-for="StartTime"></span>
                                </div>
                            </div>
                            <div class="col-xl-auto col-md-6">
                                <div class="appoinment-page__input-box text-center">
                                    <label style="font-size: 1.0rem" class="col-auto col-form-label"><strong>Profissional:</strong></label>
                                    <select asp-for="StaffId" asp-items="Model.Staff"></select>
                                    <span style="display: block;" class="text-danger" asp-validation-for="StaffId"></span>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            @if (User.IsInRole("Colaborador") || User.IsInRole("Administrador"))
                            {
                                <div class="col-xl-auto col-md-6">
                                    <div class="appoinment-page__input-box text-center">
                                        <label style="font-size: 1.0rem" class="col-auto col-form-label"><strong>Paciente:</strong></label>
                                        <select asp-for="PatientId" asp-items="Model.Patients"></select>
                                        <span style="display: block;" class="text-danger" asp-validation-for="PatientId"></span>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <input type="hidden" asp-for="PatientId" />
                            }
                            <div class="col-xl-12">
                                <div class="appoinment-page__input-box text-message-box">
                                    <div id="quill-editor"></div>
                                    <input type="hidden" asp-for="Notes" id="Notes" />
                                </div>
                                <div class="appoinment-page__btn-box" style="margin-top: 70px">
                                    <button type="submit" asp-action="Index" id="btnConfirm" class="thm-btn">
                                        Marcar<span class="icon-plus"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                    <div style="margin-top: 10px" class="text-success">@Html.Raw(ViewBag.AppointmentBookingMessage)</div>
                    <div asp-validation-summary="ModelOnly"></div>
                </div>
            </div>
            <div class="col-xl-4 col-lg-5">
                <div class="appoinment-page__right">
                    <div class="appoinment-page__working-hour">
                        <h3 class="appoinment-page__working-hour-title">Informações</h3>
                        <ul class="appoinment-page__working-hour-list list-unstyled">
                            <li>
                                <p>Preço por consulta: <b>60€</b></p>
                            </li>
                            <li>
                                <p>Consultas desmarcadas até <b>24h</b> antes serão cobradas no seu valor integral.</p>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="appoinment-page__right">
                    <div class="appoinment-page__working-hour">
                        <h3 class="appoinment-page__working-hour-title">Horário de Funcionamento</h3>
                        <ul class="appoinment-page__working-hour-list list-unstyled">
                            <li>
                                <span>Segunda-Sexta</span>
                                <p>09h00 às 19h00</p>
                            </li>
                            <li>
                                <span>Sábado</span>
                                <p>09h00 às 13h00</p>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<div id="confirmDialog" class="modal fade">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Consulta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p>Queres confirmar a consulta com os seguintes dados?</p>
                <table class="table table-sm">
                    <tr><th>Paciente:</th><td id="confirmPaciente"></td></tr>
                    <tr><th>Profissional:</th><td id="confirmProfissional"></td></tr>
                    <tr><th>Data:</th><td id="confirmData"></td></tr>
                    <tr><th>Hora:</th><td id="confirmHora"></td></tr>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="btnYes">Confirmar</button>
                <button type="button" class="btn btn-secondary" id="btnNo">Cancelar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        $(document).ready(function () {
            const $appointmentDate = $('#AppointmentDate');
            const $timeSlots = $('#timeSlots');
            const $btnConfirm = $('#btnConfirm');

            const hasAvailableCredits = @Model.HasAvailableCredits.ToString().ToLower(); 

            const appointmentSection = document.getElementById("appointment-section");
            if (appointmentSection) {
                appointmentSection.scrollIntoView({ behavior: "smooth" });
            }

            const toolbarOptions = [['bold', 'italic', 'underline'], ['link'], ['clean']];
            const quill = new Quill('#quill-editor', {
                theme: 'snow',
                placeholder: 'Motivo da consulta(opcional)',
                modules: { toolbar: toolbarOptions }
            });

            $('form').on('submit', function () {
                $('#Notes').val(quill.root.innerHTML);
            });

            function loadTimeSlots(date) {
                if (!date) return;

                $.getJSON('api/Appointments/AvailableTimeSlots', { date: date })
                    .done(function (data) {
                        $timeSlots.empty();

                        if (data.length === 0) {
                            $timeSlots.append($('<option>', {
                                value: '',
                                text: 'Sem horários disponíveis',
                                disabled: true,
                                selected: true
                            }));
                            $btnConfirm.prop('disabled', true);
                        } else {
                            $.each(data, function (i, slot) {
                                $timeSlots.append($('<option>', { value: slot.value, text: slot.text }));
                            });
                            $timeSlots.val(data[0].value);

                            $btnConfirm.prop('disabled', !hasAvailableCredits);
                        }

                        $timeSlots.niceSelect('update');
                    })
                    .fail(function () {
                        $btnConfirm.prop('disabled', true);
                    });
            }

            loadTimeSlots($appointmentDate.val());

            $appointmentDate.on('change', function () {
                const selectedDate = $(this).val();
                loadTimeSlots(selectedDate);
            });

            const confirmDialogEl = document.getElementById('confirmDialog');
            const confirmDialog = new bootstrap.Modal(confirmDialogEl);

            $btnConfirm.click(function (e) {
                e.preventDefault();

                const paciente = $("#PatientId").is("select")
                    ? $("#PatientId option:selected").text().trim()
                    : "@User.Identity.Name".trim();

                const profissional = $("#StaffId option:selected").text().trim();
                const data = $("#AppointmentDate").val();
                const hora = $("#timeSlots option:selected").text().trim();

                let formattedDate = "—";
                if (data) {
                    const d = new Date(data);
                    formattedDate = `${String(d.getDate()).padStart(2, '0')}-${String(d.getMonth() + 1).padStart(2, '0')}-${d.getFullYear()}`;
                }

                $("#confirmPaciente").text(paciente || "—");
                $("#confirmProfissional").text(profissional || "—");
                $("#confirmData").text(formattedDate);
                $("#confirmHora").text(hora || "—");

                confirmDialog.show();
            });

            $("#btnYes").click(function () {
                confirmDialog.hide();
                $("form.appoinment-page__form").submit();
            });

            $("#btnNo").click(function () {
                confirmDialog.hide();
            });
        });
    </script>
}